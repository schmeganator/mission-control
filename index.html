<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mission Control</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap');

  :root {
    --space-bg: #020b18;
    --neon-blue: #00d4ff;
    --neon-green: #00ff88;
    --neon-red: #ff3355;
    --neon-yellow: #ffd700;
    --neon-purple: #b44fff;
    --panel-bg: rgba(0, 20, 50, 0.85);
    --panel-border: rgba(0, 212, 255, 0.3);
    --text-main: #e0f4ff;
    --text-dim: #6a9ab8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--space-bg);
    font-family: 'Exo 2', sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
  }

  #stars { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
  .star { position:absolute; background:white; border-radius:50%; animation:twinkle var(--dur) ease-in-out infinite; opacity:0; }
  @keyframes twinkle { 0%,100%{opacity:0} 50%{opacity:var(--bright)} }

  body::after {
    content:''; position:fixed; top:0;left:0;width:100%;height:100%;
    background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);
    pointer-events:none; z-index:1;
  }

  .app { position:relative; z-index:2; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px; }

  .header { text-align:center; margin-bottom:30px; width:100%; }
  .header h1 { font-family:'Orbitron',sans-serif; font-size:clamp(1.8rem,5vw,3rem); font-weight:900; color:var(--neon-blue); text-shadow:0 0 20px var(--neon-blue),0 0 40px rgba(0,212,255,0.3); letter-spacing:0.15em; text-transform:uppercase; }
  .header .subtitle { font-family:'Orbitron',sans-serif; font-size:0.75rem; color:var(--text-dim); letter-spacing:0.3em; margin-top:4px; }
  .pilot-name { font-family:'Orbitron',sans-serif; font-size:0.9rem; color:var(--neon-yellow); margin-top:8px; text-shadow:0 0 10px var(--neon-yellow); }

  .pilot-selector { display:flex; gap:16px; justify-content:center; margin-bottom:30px; flex-wrap:wrap; }
  .pilot-btn { background:var(--panel-bg); border:2px solid var(--panel-border); border-radius:16px; padding:20px 30px; cursor:pointer; transition:all 0.2s; text-align:center; min-width:140px; backdrop-filter:blur(10px); }
  .pilot-btn:hover,.pilot-btn.active { border-color:var(--neon-blue); box-shadow:0 0 20px rgba(0,212,255,0.3),inset 0 0 20px rgba(0,212,255,0.05); transform:translateY(-2px); }
  .pilot-btn .pilot-icon { font-size:2.5rem; display:block; margin-bottom:8px; }
  .pilot-btn .pilot-label { font-family:'Orbitron',sans-serif; font-size:0.85rem; font-weight:700; color:var(--neon-blue); }

  .mission-progress { width:100%; max-width:600px; background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:12px; padding:20px; margin-bottom:24px; backdrop-filter:blur(10px); }
  .progress-label { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .progress-label span { font-family:'Orbitron',sans-serif; font-size:0.75rem; color:var(--text-dim); letter-spacing:0.1em; }
  .progress-label .progress-count { color:var(--neon-green); font-weight:700; text-shadow:0 0 8px var(--neon-green); }
  .progress-bar-track { background:rgba(0,212,255,0.1); border-radius:999px; height:16px; overflow:hidden; border:1px solid rgba(0,212,255,0.2); }
  .progress-bar-fill { height:100%; border-radius:999px; background:linear-gradient(90deg,var(--neon-blue),var(--neon-green)); transition:width 0.6s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 0 12px var(--neon-green); position:relative; }
  .progress-bar-fill::after { content:''; position:absolute; top:2px;left:10px;right:10px;bottom:2px; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent); border-radius:999px; animation:shimmer 2s linear infinite; }
  @keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(200%)} }

  .chores-grid { width:100%; max-width:600px; display:flex; flex-direction:column; gap:12px; margin-bottom:24px; }
  .chore-card { background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:16px; padding:18px 20px; backdrop-filter:blur(10px); transition:all 0.2s; position:relative; overflow:hidden; }
  .chore-card::before { content:''; position:absolute; top:0;left:0;width:4px;height:100%; background:var(--neon-blue); box-shadow:0 0 10px var(--neon-blue); }
  .chore-card.completed::before { background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); }
  .chore-card.completed { border-color:rgba(0,255,136,0.3); }
  .chore-card.failed::before { background:var(--neon-red); box-shadow:0 0 10px var(--neon-red); }
  .chore-top { display:flex; align-items:center; gap:14px; }
  .chore-icon { font-size:2rem; flex-shrink:0; }
  .chore-info { flex:1; }
  .chore-name { font-family:'Orbitron',sans-serif; font-size:0.95rem; font-weight:700; color:var(--text-main); margin-bottom:3px; }
  .chore-desc { font-size:0.8rem; color:var(--text-dim); }
  .chore-status { font-size:1.8rem; flex-shrink:0; }
  .chore-actions { margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .btn { font-family:'Orbitron',sans-serif; font-size:0.75rem; font-weight:700; letter-spacing:0.1em; border:none; border-radius:10px; padding:12px 20px; cursor:pointer; transition:all 0.15s; text-transform:uppercase; }
  .btn:active { transform:scale(0.96); }
  .btn-primary { background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,212,255,0.1)); border:1px solid var(--neon-blue); color:var(--neon-blue); box-shadow:0 0 10px rgba(0,212,255,0.2); }
  .btn-primary:hover { box-shadow:0 0 20px rgba(0,212,255,0.4); background:rgba(0,212,255,0.2); }
  .btn-success { background:linear-gradient(135deg,rgba(0,255,136,0.2),rgba(0,255,136,0.1)); border:1px solid var(--neon-green); color:var(--neon-green); box-shadow:0 0 10px rgba(0,255,136,0.2); }
  .btn-danger { background:linear-gradient(135deg,rgba(255,51,85,0.2),rgba(255,51,85,0.1)); border:1px solid var(--neon-red); color:var(--neon-red); }
  .btn-ghost { background:transparent; border:1px solid var(--text-dim); color:var(--text-dim); font-size:0.65rem; }

  /* ===== ENTRY SCREEN ===== */
  .entry-screen { position:fixed; inset:0; background:var(--space-bg); z-index:500; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:22px; padding:30px; }
  .entry-logo { font-size:4rem; animation:float 3s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-12px)} }
  .entry-title { font-family:'Orbitron',sans-serif; font-size:clamp(1.5rem,5vw,2.5rem); font-weight:900; color:var(--neon-blue); text-shadow:0 0 20px var(--neon-blue),0 0 40px rgba(0,212,255,0.3); letter-spacing:0.15em; text-align:center; }
  .entry-subtitle { font-family:'Orbitron',sans-serif; font-size:0.7rem; color:var(--text-dim); letter-spacing:0.3em; text-align:center; }

  /* PIN shared styles */
  .pin-heading { font-family:'Orbitron',sans-serif; font-size:0.9rem; letter-spacing:0.2em; }
  .pin-heading.blue { color:var(--neon-blue); }
  .pin-heading.purple { color:var(--neon-purple); }

  .pin-dots { display:flex; gap:14px; }
  .pin-dot { width:20px; height:20px; border-radius:50%; transition:background 0.1s,box-shadow 0.1s; }
  .pin-dot.blue { border:2px solid var(--neon-blue); }
  .pin-dot.blue.filled { background:var(--neon-blue); box-shadow:0 0 12px var(--neon-blue); }
  .pin-dot.purple { border:2px solid var(--neon-purple); }
  .pin-dot.purple.filled { background:var(--neon-purple); box-shadow:0 0 12px var(--neon-purple); }

  .pin-keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; max-width:280px; width:100%; }
  .pin-key { font-family:'Orbitron',sans-serif; font-size:1.3rem; font-weight:700; border-radius:14px; padding:20px; cursor:pointer; transition:all 0.1s; text-align:center; }
  .pin-key.blue { background:rgba(0,212,255,0.1); border:1px solid rgba(0,212,255,0.3); color:var(--neon-blue); }
  .pin-key.blue:active { background:rgba(0,212,255,0.3); transform:scale(0.94); }
  .pin-key.purple { background:rgba(180,79,255,0.1); border:1px solid rgba(180,79,255,0.3); color:var(--neon-purple); }
  .pin-key.purple:active { background:rgba(180,79,255,0.3); transform:scale(0.94); }

  .pin-error { font-family:'Orbitron',sans-serif; font-size:0.75rem; color:var(--neon-red); letter-spacing:0.1em; text-shadow:0 0 8px var(--neon-red); animation:shake 0.3s ease; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }

  /* Camera */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,5,15,0.95); z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }
  .modal-title { font-family:'Orbitron',sans-serif; font-size:1rem; color:var(--neon-blue); letter-spacing:0.15em; margin-bottom:16px; text-align:center; }
  #cameraView,#capturedImage { width:100%; max-width:500px; max-height:55vh; border-radius:12px; border:2px solid var(--neon-blue); box-shadow:0 0 30px rgba(0,212,255,0.3); object-fit:cover; background:#000; }
  .modal-actions { display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; justify-content:center; }

  /* Analyzing */
  .analyzing-overlay { position:fixed; inset:0; background:rgba(0,5,15,0.97); z-index:200; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }
  .radar { width:120px; height:120px; border:2px solid rgba(0,212,255,0.3); border-radius:50%; position:relative; animation:radarSpin 1.5s linear infinite; }
  .radar::before { content:''; position:absolute; top:50%;left:50%; width:50%;height:2px; background:linear-gradient(90deg,var(--neon-blue),transparent); transform-origin:left center; transform:translateY(-50%); }
  .radar::after { content:''; position:absolute; inset:10px; border:1px solid rgba(0,212,255,0.15); border-radius:50%; }
  @keyframes radarSpin { to{transform:rotate(360deg)} }
  .analyzing-text { font-family:'Orbitron',sans-serif; font-size:0.9rem; color:var(--neon-blue); letter-spacing:0.2em; animation:pulse 1s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* Result */
  .result-overlay { position:fixed; inset:0; z-index:200; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center; }
  .result-overlay.pass { background:radial-gradient(ellipse at center,rgba(0,255,136,0.15) 0%,rgba(0,5,15,0.97) 70%); }
  .result-overlay.fail { background:radial-gradient(ellipse at center,rgba(255,51,85,0.15) 0%,rgba(0,5,15,0.97) 70%); }
  .result-icon { font-size:5rem; margin-bottom:16px; animation:popIn 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes popIn { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }
  .result-title { font-family:'Orbitron',sans-serif; font-size:clamp(1.8rem,6vw,3rem); font-weight:900; margin-bottom:12px; }
  .result-overlay.pass .result-title { color:var(--neon-green); text-shadow:0 0 30px var(--neon-green); }
  .result-overlay.fail .result-title { color:var(--neon-red); text-shadow:0 0 30px var(--neon-red); }
  .result-score { font-family:'Orbitron',sans-serif; font-size:1.1rem; color:var(--text-dim); margin-bottom:8px; }
  .result-feedback { font-size:1rem; color:var(--text-main); max-width:400px; line-height:1.6; margin-bottom:24px; font-style:italic; }

  /* Unlock */
  .unlock-screen { position:fixed; inset:0; z-index:300; background:radial-gradient(ellipse at center,rgba(0,255,136,0.2) 0%,var(--space-bg) 60%); display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:30px; }
  .unlock-rocket { font-size:5rem; animation:rocketLaunch 1s ease-out forwards; }
  @keyframes rocketLaunch { 0%{transform:translateY(0) scale(1)} 50%{transform:translateY(-30px) scale(1.2)} 100%{transform:translateY(-10px) scale(1.1)} }
  .unlock-title { font-family:'Orbitron',sans-serif; font-size:clamp(2rem,7vw,4rem); font-weight:900; color:var(--neon-green); text-shadow:0 0 40px var(--neon-green),0 0 80px rgba(0,255,136,0.3); margin:20px 0 12px; animation:titleGlow 2s ease-in-out infinite; }
  @keyframes titleGlow { 0%,100%{text-shadow:0 0 40px var(--neon-green),0 0 80px rgba(0,255,136,0.3)} 50%{text-shadow:0 0 60px var(--neon-green),0 0 120px rgba(0,255,136,0.5)} }
  .unlock-subtitle { font-family:'Orbitron',sans-serif; font-size:1rem; color:var(--neon-yellow); letter-spacing:0.2em; margin-bottom:8px; }
  .unlock-time { font-family:'Orbitron',sans-serif; font-size:3rem; font-weight:900; color:var(--neon-yellow); text-shadow:0 0 20px var(--neon-yellow); margin:16px 0; }

  canvas#confettiCanvas { position:fixed; inset:0; pointer-events:none; z-index:350; }

  /* Parent */
  .parent-toggle { position:fixed; bottom:20px; right:20px; z-index:50; }
  .parent-toggle .btn { font-size:0.6rem; padding:10px 14px; opacity:0.5; }
  .parent-toggle .btn:hover { opacity:1; }

  .pin-modal { position:fixed; inset:0; background:rgba(0,5,15,0.97); z-index:150; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }

  .parent-panel { position:fixed; inset:0; background:var(--space-bg); z-index:150; overflow-y:auto; padding:30px 20px; }
  .parent-panel h2 { font-family:'Orbitron',sans-serif; font-size:1.2rem; color:var(--neon-purple); letter-spacing:0.15em; margin-bottom:24px; text-shadow:0 0 15px var(--neon-purple); }
  .settings-section { background:var(--panel-bg); border:1px solid rgba(180,79,255,0.3); border-radius:16px; padding:20px; margin-bottom:20px; max-width:600px; }
  .settings-section h3 { font-family:'Orbitron',sans-serif; font-size:0.8rem; color:var(--neon-purple); letter-spacing:0.15em; margin-bottom:16px; }
  .setting-row { display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
  .setting-row label { font-size:0.85rem; color:var(--text-dim); min-width:130px; }
  .setting-input { background:rgba(0,0,0,0.4); border:1px solid rgba(180,79,255,0.3); color:var(--text-main); border-radius:8px; padding:8px 12px; font-family:'Exo 2',sans-serif; font-size:0.9rem; flex:1; min-width:0; }
  .setting-input:focus { outline:none; border-color:var(--neon-purple); }
  .chore-editor { border:1px dashed rgba(180,79,255,0.2); border-radius:10px; padding:14px; margin-bottom:10px; }
  .chore-editor-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
  .chore-editor-row input,.chore-editor-row select { background:rgba(0,0,0,0.4); border:1px solid rgba(180,79,255,0.3); color:var(--text-main); border-radius:6px; padding:6px 10px; font-family:'Exo 2',sans-serif; font-size:0.8rem; }
  .chore-editor-row input:focus,.chore-editor-row select:focus { outline:none; border-color:var(--neon-purple); }
  .delete-chore { background:none; border:none; color:var(--neon-red); font-size:1.2rem; cursor:pointer; padding:4px 8px; border-radius:6px; transition:background 0.1s; }
  .delete-chore:hover { background:rgba(255,51,85,0.1); }
  .api-warning { background:rgba(255,211,0,0.1); border:1px solid rgba(255,211,0,0.3); border-radius:10px; padding:12px 16px; font-size:0.8rem; color:var(--neon-yellow); line-height:1.5; margin-bottom:12px; }

  .hidden { display:none !important; }
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:rgba(0,212,255,0.3); border-radius:999px; }
</style>
</head>
<body>

<div id="stars"></div>
<canvas id="confettiCanvas" class="hidden"></canvas>

<!-- ENTRY PIN SCREEN -->
<div class="entry-screen" id="entryScreen">
  <div class="entry-logo">üöÄ</div>
  <div class="entry-title">MISSION CONTROL</div>
  <div class="entry-subtitle">SCREEN TIME AUTHORIZATION SYSTEM</div>
  <div class="pin-heading blue">ENTER ACCESS CODE</div>
  <div class="pin-dots" id="entryDots"></div>
  <div class="pin-keypad" id="entryKeypad"></div>
  <div class="pin-error hidden" id="entryError">ACCESS DENIED</div>
</div>

<!-- MAIN APP -->
<div class="app hidden" id="mainApp">
  <div class="header">
    <h1>üöÄ Mission Control</h1>
    <div class="subtitle">SCREEN TIME AUTHORIZATION SYSTEM</div>
    <div class="pilot-name" id="pilotDisplay"></div>
  </div>
  <div class="pilot-selector" id="pilotSelector"></div>
  <div class="mission-progress" id="missionProgress" style="display:none">
    <div class="progress-label">
      <span>MISSION PROGRESS</span>
      <span class="progress-count" id="progressCount">0 / 0 COMPLETE</span>
    </div>
    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>
  <div class="chores-grid" id="choresGrid"></div>
</div>

<!-- Camera -->
<div class="modal-overlay hidden" id="cameraModal">
  <div class="modal-title" id="cameraModalTitle">üì∏ SCAN YOUR MISSION</div>
  <video id="cameraView" autoplay playsinline></video>
  <img id="capturedImage" style="display:none" />
  <div class="modal-actions">
    <button class="btn btn-primary" id="snapBtn" onclick="snapPhoto()">‚ö° SCAN</button>
    <button class="btn btn-success hidden" id="submitBtn" onclick="submitPhoto()" disabled>‚úÖ SUBMIT</button>
    <button class="btn btn-ghost hidden" id="retakeBtn" onclick="retakePhoto()">‚Ü© RETAKE</button>
    <button class="btn btn-danger" onclick="closeCamera()">‚úï CANCEL</button>
  </div>
</div>

<!-- Analyzing -->
<div class="analyzing-overlay hidden" id="analyzingOverlay">
  <div class="radar"></div>
  <div class="analyzing-text">ANALYZING MISSION...</div>
  <div style="font-size:0.75rem;color:var(--text-dim);letter-spacing:0.2em">AI SCANNING IN PROGRESS</div>
</div>

<!-- Result -->
<div class="result-overlay hidden" id="resultOverlay">
  <div class="result-icon" id="resultIcon"></div>
  <div class="result-title" id="resultTitle"></div>
  <div class="result-score" id="resultScore"></div>
  <div class="result-feedback" id="resultFeedback"></div>
  <button class="btn btn-primary" onclick="closeResult()" id="resultBtn">CONTINUE</button>
</div>

<!-- Unlock -->
<div class="unlock-screen hidden" id="unlockScreen">
  <div class="unlock-rocket">üöÄ</div>
  <div class="unlock-title" id="unlockTitle">SCREEN TIME UNLOCKED!</div>
  <div class="unlock-subtitle">MISSION COMPLETE, PILOT</div>
  <div class="unlock-time" id="unlockCountdown"></div>
  <div style="font-size:0.8rem;color:var(--text-dim);font-family:'Orbitron',sans-serif;letter-spacing:0.1em">MINUTES REMAINING</div>
  <button class="btn btn-ghost" style="margin-top:30px" onclick="resetMission()">NEW MISSION</button>
</div>

<!-- Parent toggle -->
<div class="parent-toggle hidden" id="parentToggle">
  <button class="btn btn-ghost" onclick="showParentPinModal()">‚öô COMMAND</button>
</div>

<!-- Parent PIN modal -->
<div class="pin-modal hidden" id="parentPinModal">
  <div class="pin-heading purple">üîê COMMAND ACCESS</div>
  <div class="pin-dots" id="parentPinDots"></div>
  <div class="pin-keypad" id="parentPinKeypad"></div>
  <div class="pin-error hidden" id="parentPinError">ACCESS DENIED</div>
  <button class="btn btn-ghost" style="margin-top:8px" onclick="hideParentPinModal()">CANCEL</button>
</div>

<!-- Parent panel -->
<div class="parent-panel hidden" id="parentPanel">
  <h2>‚öô COMMAND CENTER</h2>

  <div class="settings-section">
    <h3>üîë API CONFIGURATION</h3>
    <div class="api-warning">‚ö† Required: Enter your Anthropic API key to enable AI photo verification. Get one at console.anthropic.com ‚Äî stored locally in your browser only.</div>
    <div class="setting-row">
      <label>API Key</label>
      <input class="setting-input" type="password" id="apiKeyInput" placeholder="sk-ant-..." />
    </div>
    <button class="btn btn-primary" style="margin-top:8px" onclick="saveApiKey()">SAVE KEY</button>
  </div>

  <div class="settings-section">
    <h3>üöÄ PILOTS</h3>
    <div id="pilotEditors"></div>
    <button class="btn btn-ghost" style="font-size:0.65rem" onclick="addPilot()">+ ADD PILOT</button>
  </div>

  <div class="settings-section">
    <h3>üìã MISSION CHORES</h3>
    <div id="choreEditors"></div>
    <button class="btn btn-ghost" style="font-size:0.65rem" onclick="addChore()">+ ADD CHORE</button>
  </div>

  <div class="settings-section">
    <h3>üéØ THRESHOLDS & ACCESS</h3>
    <div class="setting-row"><label>Pass Score (%)</label><input class="setting-input" type="number" id="thresholdInput" min="1" max="100" value="80" style="max-width:80px" /></div>
    <div class="setting-row"><label>Screen Time (min)</label><input class="setting-input" type="number" id="screenTimeInput" min="5" max="240" value="60" style="max-width:80px" /></div>
    <div class="setting-row"><label>Kids Entry PIN</label><input class="setting-input" type="password" id="entryPinInput" maxlength="4" placeholder="4 digits" style="max-width:100px" /></div>
    <div class="setting-row"><label>Parent PIN</label><input class="setting-input" type="password" id="parentPinInput" maxlength="4" placeholder="4 digits" style="max-width:100px" /></div>
  </div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;padding-bottom:40px">
    <button class="btn btn-success" onclick="saveSettings()">üíæ SAVE ALL SETTINGS</button>
    <button class="btn btn-danger" onclick="hideParentPanel()">‚úï CLOSE</button>
  </div>
</div>

<script>
let state = {
  apiKey: '',
  pilots: [
    { id: 'p1', name: 'Pilot 1', icon: 'üë¶' },
    { id: 'p2', name: 'Pilot 2', icon: 'üëß' }
  ],
  chores: [
    { id: 'c1', name: 'Clean Room', desc: 'Floor clear, bed made', icon: 'üõèÔ∏è', requiresPhoto: true },
    { id: 'c2', name: 'Brush Teeth', desc: 'Morning & night', icon: 'ü¶∑', requiresPhoto: false },
    { id: 'c3', name: 'Put Away Dishes', desc: 'Dishes in cupboard', icon: 'üçΩÔ∏è', requiresPhoto: true },
  ],
  threshold: 80,
  screenTimeMinutes: 60,
  entryPin: '0000',
  parentPin: '1234',
  currentPilot: null,
  progress: {},
  unlockTimers: {},
};

let cameraStream = null;
let capturedBlob = null;
let currentChoreId = null;
let entryBuf = '';
let parentBuf = '';
let unlockInterval = null;

// INIT
function init() {
  const saved = localStorage.getItem('missionControl');
  if (saved) { try { state = {...state, ...JSON.parse(saved)}; } catch(e){} }
  generateStars();
  buildKeypad('entryKeypad', 'blue', handleEntryKey);
  updateDots('entryDots', entryBuf, 'blue');
}

function save() { localStorage.setItem('missionControl', JSON.stringify(state)); }

// STARS
function generateStars() {
  const c = document.getElementById('stars');
  for (let i=0; i<150; i++) {
    const s = document.createElement('div'); s.className = 'star';
    const sz = Math.random()*2.5+0.5;
    s.style.cssText = `width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;--dur:${2+Math.random()*4}s;--bright:${0.3+Math.random()*0.7};animation-delay:${Math.random()*5}s`;
    c.appendChild(s);
  }
}

// PIN HELPERS
function buildKeypad(id, color, handler) {
  const kp = document.getElementById(id);
  if (kp.children.length) return;
  ['1','2','3','4','5','6','7','8','9','‚å´','0','‚Üµ'].forEach(k => {
    const b = document.createElement('button');
    b.className = `pin-key ${color}`; b.textContent = k;
    b.onclick = () => handler(k);
    kp.appendChild(b);
  });
}

function updateDots(id, buf, color) {
  const c = document.getElementById(id); c.innerHTML = '';
  for (let i=0; i<4; i++) {
    const d = document.createElement('div');
    d.className = `pin-dot ${color}${i < buf.length ? ' filled' : ''}`;
    c.appendChild(d);
  }
}

function showError(id) {
  const e = document.getElementById(id);
  e.classList.remove('hidden');
  setTimeout(() => e.classList.add('hidden'), 2000);
}

// ENTRY PIN
function handleEntryKey(k) {
  if (k === '‚å´') entryBuf = entryBuf.slice(0,-1);
  else if (k === '‚Üµ') { checkEntry(); return; }
  else if (entryBuf.length < 4) entryBuf += k;
  updateDots('entryDots', entryBuf, 'blue');
  if (entryBuf.length === 4) checkEntry();
}

function checkEntry() {
  if (entryBuf === state.entryPin) {
    document.getElementById('entryScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('parentToggle').classList.remove('hidden');
    entryBuf = '';
    renderPilots();
  } else {
    entryBuf = '';
    updateDots('entryDots', entryBuf, 'blue');
    showError('entryError');
  }
}

// PARENT PIN
function showParentPinModal() {
  parentBuf = '';
  buildKeypad('parentPinKeypad', 'purple', handleParentKey);
  updateDots('parentPinDots', parentBuf, 'purple');
  document.getElementById('parentPinModal').classList.remove('hidden');
}

function hideParentPinModal() {
  parentBuf = '';
  document.getElementById('parentPinModal').classList.add('hidden');
}

function handleParentKey(k) {
  if (k === '‚å´') parentBuf = parentBuf.slice(0,-1);
  else if (k === '‚Üµ') { checkParent(); return; }
  else if (parentBuf.length < 4) parentBuf += k;
  updateDots('parentPinDots', parentBuf, 'purple');
  if (parentBuf.length === 4) checkParent();
}

function checkParent() {
  if (parentBuf === state.parentPin) {
    hideParentPinModal();
    openParentPanel();
  } else {
    parentBuf = '';
    updateDots('parentPinDots', parentBuf, 'purple');
    showError('parentPinError');
  }
}

// PILOTS
function renderPilots() {
  const c = document.getElementById('pilotSelector'); c.innerHTML = '';
  state.pilots.forEach(p => {
    const b = document.createElement('div');
    b.className = 'pilot-btn' + (state.currentPilot === p.id ? ' active' : '');
    b.innerHTML = `<span class="pilot-icon">${p.icon}</span><span class="pilot-label">${p.name}</span>`;
    b.onclick = () => selectPilot(p.id);
    c.appendChild(b);
  });
}

function selectPilot(id) {
  state.currentPilot = id;
  if (!state.progress[id]) state.progress[id] = {};
  save(); renderPilots(); renderChores(); updateProgress();
  document.getElementById('missionProgress').style.display = 'block';
  const p = state.pilots.find(x => x.id === id);
  document.getElementById('pilotDisplay').textContent = `PILOT: ${p.name.toUpperCase()}`;
  if (state.unlockTimers[id] > 0) showUnlock();
}

// CHORES
function renderChores() {
  const g = document.getElementById('choresGrid'); g.innerHTML = '';
  if (!state.currentPilot) return;
  const prog = state.progress[state.currentPilot] || {};
  state.chores.forEach(ch => {
    const st = prog[ch.id];
    const card = document.createElement('div');
    card.className = 'chore-card' + (st==='done'?' completed':st==='failed'?' failed':'');
    const icon = st==='done'?'‚úÖ':st==='failed'?'‚ùå':'‚≠ï';
    let action = st !== 'done'
      ? (ch.requiresPhoto
          ? `<button class="btn btn-primary" onclick="openCamera('${ch.id}')">üì∏ SCAN MISSION</button>`
          : `<button class="btn btn-success" onclick="markDone('${ch.id}')">‚úÖ MARK DONE</button>`)
      : `<span style="font-family:'Orbitron',sans-serif;font-size:0.7rem;color:var(--neon-green);letter-spacing:0.1em">‚úì MISSION COMPLETE</span>`;
    card.innerHTML = `<div class="chore-top"><div class="chore-icon">${ch.icon}</div><div class="chore-info"><div class="chore-name">${ch.name}</div><div class="chore-desc">${ch.desc}</div></div><div class="chore-status">${icon}</div></div><div class="chore-actions">${action}</div>`;
    g.appendChild(card);
  });
}

function markDone(id) {
  state.progress[state.currentPilot][id] = 'done'; save(); renderChores(); updateProgress(); checkComplete();
}

function updateProgress() {
  if (!state.currentPilot) return;
  const done = Object.values(state.progress[state.currentPilot]||{}).filter(v=>v==='done').length;
  const total = state.chores.length;
  document.getElementById('progressCount').textContent = `${done} / ${total} COMPLETE`;
  document.getElementById('progressFill').style.width = (total > 0 ? done/total*100 : 0) + '%';
}

function checkComplete() {
  if (!state.currentPilot) return;
  const done = Object.values(state.progress[state.currentPilot]||{}).filter(v=>v==='done').length;
  if (done >= state.chores.length) {
    setTimeout(() => { state.unlockTimers[state.currentPilot] = state.screenTimeMinutes*60; save(); showUnlock(); launchConfetti(); }, 600);
  }
}

// CAMERA
async function openCamera(choreId) {
  currentChoreId = choreId;
  const ch = state.chores.find(c=>c.id===choreId);
  document.getElementById('cameraModalTitle').textContent = `üì∏ SCAN: ${ch.name.toUpperCase()}`;
  document.getElementById('cameraModal').classList.remove('hidden');
  const video = document.getElementById('cameraView');
  const img = document.getElementById('capturedImage');
  video.style.display='block'; img.style.display='none';
  document.getElementById('snapBtn').classList.remove('hidden');
  document.getElementById('submitBtn').classList.add('hidden');
  document.getElementById('retakeBtn').classList.add('hidden');
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = cameraStream;
  } catch(e) { alert('Camera not available.'); closeCamera(); }
}

function snapPhoto() {
  const video = document.getElementById('cameraView');
  if (!video.videoWidth || !video.videoHeight) {
    alert('Camera not ready yet, try again in a moment.');
    return;
  }
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  // Disable snap button immediately to prevent double-tap
  document.getElementById('snapBtn').disabled = true;

  canvas.toBlob(blob => {
    if (!blob) {
      alert('Failed to capture photo. Please try again.');
      document.getElementById('snapBtn').disabled = false;
      return;
    }
    capturedBlob = blob;
    const url = URL.createObjectURL(blob);
    const img = document.getElementById('capturedImage');
    const submitBtn = document.getElementById('submitBtn');
    // Keep submit disabled until image is fully loaded
    submitBtn.disabled = true;
    img.onload = () => {
      video.style.display = 'none';
      img.style.display = 'block';
      document.getElementById('snapBtn').classList.add('hidden');
      document.getElementById('snapBtn').disabled = false;
      submitBtn.classList.remove('hidden');
      submitBtn.disabled = false; // Only enable AFTER image confirmed loaded
      document.getElementById('retakeBtn').classList.remove('hidden');
    };
    img.onerror = () => {
      capturedBlob = null;
      alert('Failed to load photo preview. Please try again.');
      document.getElementById('snapBtn').disabled = false;
    };
    img.src = url;
    if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
  }, 'image/jpeg', 0.85);
}

function retakePhoto() {
  capturedBlob = null;
  const video = document.getElementById('cameraView');
  const img = document.getElementById('capturedImage');
  const submitBtn = document.getElementById('submitBtn');
  video.style.display = 'block';
  img.style.display = 'none';
  img.src = '';
  document.getElementById('snapBtn').classList.remove('hidden');
  document.getElementById('snapBtn').disabled = false;
  submitBtn.classList.add('hidden');
  submitBtn.disabled = true;
  document.getElementById('retakeBtn').classList.add('hidden');
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{cameraStream=s;video.srcObject=s;});
}

function closeCamera() {
  if (cameraStream) cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream = null;
  // NOTE: do NOT null capturedBlob here ‚Äî submitPhoto needs it after closing camera
  document.getElementById('cameraModal').classList.add('hidden');
}

async function submitPhoto() {
  if (!capturedBlob || !(capturedBlob instanceof Blob)) {
    alert('No photo captured. Please snap a photo first.');
    return;
  }
  if (!state.apiKey) { alert('No API key set! Go to ‚öô COMMAND settings.'); return; }
  // Grab blob reference BEFORE closing camera
  const blobToSubmit = capturedBlob;
  closeCamera();
  capturedBlob = null; // safe to null now that we have blobToSubmit
  document.getElementById('analyzingOverlay').classList.remove('hidden');
  const ch = state.chores.find(c => c.id === currentChoreId);
  const reader = new FileReader();
  reader.onloadend = async () => {
    if (!reader.result || !reader.result.includes(',')) {
      document.getElementById('analyzingOverlay').classList.add('hidden');
      alert('Failed to read photo data. Please try again.');
      return;
    }
    const b64 = reader.result.split(',')[1];
    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': state.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-opus-4-6', max_tokens: 300,
          messages: [{role: 'user', content: [
            {type: 'image', source: {type: 'base64', media_type: 'image/jpeg', data: b64}},
            {type: 'text', text: `You are a friendly chore inspector for a 7-year-old. The chore is: "${ch.name}" - ${ch.desc}.\nScore 0-100. Pass threshold: ${state.threshold}%.\nRespond ONLY in JSON: {"score":<0-100>,"pass":<true/false>,"feedback":"<one short encouraging space-explorer sentence under 20 words>"}`}
          ]}]
        })
      });
      const data = await res.json();
      document.getElementById('analyzingOverlay').classList.add('hidden');
      if (!res.ok) throw new Error(data.error?.message || `API error ${res.status}`);
      let result;
      try {
        result = JSON.parse(data.content[0].text.trim());
      } catch(e) {
        throw new Error('Could not parse AI response. Try again.');
      }
      showResult(result);
    } catch(e) {
      document.getElementById('analyzingOverlay').classList.add('hidden');
      alert('Error: ' + e.message);
    }
  };
  reader.onerror = () => {
    document.getElementById('analyzingOverlay').classList.add('hidden');
    alert('Failed to read photo. Please try again.');
  };
  reader.readAsDataURL(blobToSubmit);
}

function showResult(result) {
  const o = document.getElementById('resultOverlay');
  o.className = 'result-overlay ' + (result.pass?'pass':'fail');
  document.getElementById('resultIcon').textContent = result.pass?'üåü':'üîÑ';
  document.getElementById('resultTitle').textContent = result.pass?'MISSION PASSED!':'NOT YET, PILOT';
  document.getElementById('resultScore').textContent = `SCAN SCORE: ${result.score}% (THRESHOLD: ${state.threshold}%)`;
  document.getElementById('resultFeedback').textContent = result.feedback;
  document.getElementById('resultBtn').textContent = result.pass?'AWESOME! ‚Üí':'TRY AGAIN ‚Üí';
  o.classList.remove('hidden');
  state.progress[state.currentPilot][currentChoreId] = result.pass?'done':'failed';
  save();
}

function closeResult() {
  document.getElementById('resultOverlay').classList.add('hidden');
  renderChores(); updateProgress(); checkComplete();
}

// UNLOCK
function showUnlock() {
  document.getElementById('unlockScreen').classList.remove('hidden');
  const p = state.pilots.find(x=>x.id===state.currentPilot);
  document.getElementById('unlockTitle').textContent = `${p?.icon||'üöÄ'} SCREEN TIME UNLOCKED!`;
  if (unlockInterval) clearInterval(unlockInterval);
  updateUnlockDisplay();
  unlockInterval = setInterval(() => {
    if (state.unlockTimers[state.currentPilot] > 0) { state.unlockTimers[state.currentPilot]--; save(); updateUnlockDisplay(); }
    else { clearInterval(unlockInterval); resetMission(); }
  }, 1000);
}

function updateUnlockDisplay() {
  const s = state.unlockTimers[state.currentPilot]||0;
  document.getElementById('unlockCountdown').textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
}

function resetMission() {
  if (unlockInterval) clearInterval(unlockInterval);
  state.progress[state.currentPilot]={};
  state.unlockTimers[state.currentPilot]=0;
  save(); document.getElementById('unlockScreen').classList.add('hidden');
  renderChores(); updateProgress();
}

// CONFETTI
function launchConfetti() {
  const canvas=document.getElementById('confettiCanvas');
  canvas.classList.remove('hidden');
  const ctx=canvas.getContext('2d');
  canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  const colors=['#00d4ff','#00ff88','#ffd700','#b44fff','#ff3355'];
  const pts=Array.from({length:80},()=>({x:Math.random()*canvas.width,y:-20,w:6+Math.random()*8,h:4+Math.random()*6,color:colors[Math.floor(Math.random()*5)],speed:3+Math.random()*5,angle:Math.random()*Math.PI*2,spin:(Math.random()-0.5)*0.2,drift:(Math.random()-0.5)*2}));
  let frame=0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let alive=false;
    pts.forEach(p=>{p.y+=p.speed;p.x+=p.drift;p.angle+=p.spin;if(p.y<canvas.height+20)alive=true;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.angle);ctx.fillStyle=p.color;ctx.globalAlpha=Math.max(0,1-p.y/canvas.height);ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);ctx.restore();});
    if(alive&&frame<200){frame++;requestAnimationFrame(draw);}else canvas.classList.add('hidden');
  }
  draw();
}

// PARENT PANEL
function openParentPanel() {
  document.getElementById('apiKeyInput').value=state.apiKey;
  document.getElementById('thresholdInput').value=state.threshold;
  document.getElementById('screenTimeInput').value=state.screenTimeMinutes;
  document.getElementById('entryPinInput').value='';
  document.getElementById('parentPinInput').value='';
  renderPilotEditors(); renderChoreEditors();
  document.getElementById('parentPanel').classList.remove('hidden');
}

function hideParentPanel() { document.getElementById('parentPanel').classList.add('hidden'); }
function saveApiKey() { state.apiKey=document.getElementById('apiKeyInput').value.trim(); save(); alert('API key saved!'); }

function renderPilotEditors() {
  const c=document.getElementById('pilotEditors'); c.innerHTML='';
  state.pilots.forEach(p=>{
    const d=document.createElement('div'); d.className='chore-editor';
    d.innerHTML=`<div class="chore-editor-row"><input value="${p.icon}" maxlength="2" style="width:50px;text-align:center" data-pilot="${p.id}" data-field="icon"/><input value="${p.name}" placeholder="Name" style="flex:1" data-pilot="${p.id}" data-field="name"/>${state.pilots.length>1?`<button class="delete-chore" onclick="removePilot('${p.id}')">‚úï</button>`:''}</div>`;
    c.appendChild(d);
  });
}

function addPilot(){state.pilots.push({id:'p'+Date.now(),name:'New Pilot',icon:'üßë'});renderPilotEditors();}
function removePilot(id){state.pilots=state.pilots.filter(p=>p.id!==id);renderPilotEditors();}

function renderChoreEditors(){
  const c=document.getElementById('choreEditors'); c.innerHTML='';
  state.chores.forEach(ch=>{
    const d=document.createElement('div'); d.className='chore-editor';
    d.innerHTML=`<div class="chore-editor-row"><input value="${ch.icon}" maxlength="2" style="width:50px;text-align:center" data-chore="${ch.id}" data-field="icon"/><input value="${ch.name}" placeholder="Chore name" style="flex:1" data-chore="${ch.id}" data-field="name"/><button class="delete-chore" onclick="removeChore('${ch.id}')">‚úï</button></div><div class="chore-editor-row"><input value="${ch.desc}" placeholder="Description" style="flex:1" data-chore="${ch.id}" data-field="desc"/><select data-chore="${ch.id}" data-field="requiresPhoto"><option value="true" ${ch.requiresPhoto?'selected':''}>üì∏ Photo</option><option value="false" ${!ch.requiresPhoto?'selected':''}>‚úÖ Manual</option></select></div>`;
    c.appendChild(d);
  });
}

function addChore(){state.chores.push({id:'c'+Date.now(),name:'New Chore',desc:'Description',icon:'‚≠ê',requiresPhoto:true});renderChoreEditors();}
function removeChore(id){state.chores=state.chores.filter(c=>c.id!==id);renderChoreEditors();}

function saveSettings(){
  document.querySelectorAll('[data-pilot]').forEach(i=>{const p=state.pilots.find(x=>x.id===i.dataset.pilot);if(p)p[i.dataset.field]=i.value;});
  document.querySelectorAll('[data-chore]').forEach(i=>{const ch=state.chores.find(x=>x.id===i.dataset.chore);if(ch){if(i.dataset.field==='requiresPhoto')ch[i.dataset.field]=i.value==='true';else ch[i.dataset.field]=i.value;}});
  state.threshold=parseInt(document.getElementById('thresholdInput').value)||80;
  state.screenTimeMinutes=parseInt(document.getElementById('screenTimeInput').value)||60;
  state.apiKey=document.getElementById('apiKeyInput').value.trim();
  const ep=document.getElementById('entryPinInput').value;
  if(ep&&ep.length===4&&/^\d{4}$/.test(ep)) state.entryPin=ep;
  const pp=document.getElementById('parentPinInput').value;
  if(pp&&pp.length===4&&/^\d{4}$/.test(pp)) state.parentPin=pp;
  save(); hideParentPanel(); renderPilots(); if(state.currentPilot) renderChores();
  alert('Settings saved! üöÄ');
}

init();
</script>
</body>
</html>
